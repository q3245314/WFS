<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»»åŠ¡é¢†å–ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <h1 contenteditable="true" id="systemTitle">ä»»åŠ¡é¢†å–ç³»ç»Ÿ</h1>

    <div class="settings-panel">
      <div class="button-container">
        <button id="toggleSettings" class="settings-btn">åŠŸèƒ½èœå•</button>
        <button id="saveTasksBtn" class="settings-btn">ä¿å­˜ä¿®æ”¹</button>
      </div>
      <div id="settingsForm" class="hidden">
        <div class="settings-row">
          <label for="taskCount">è®¾ç½®ä»»åŠ¡æ•°é‡:</label>
          <input type="number" id="taskCount" min="1" max="300" value="2">
        </div>
        <div class="settings-row">
          <label for="progressCount">è®¾ç½®è¿›åº¦æ•°é‡:</label>
          <input type="number" id="progressCount" min="1" max="10" value="4">
        </div>
        <button id="applySettings" class="settings-btn">é‡ç½®ä»»åŠ¡</button>
        <button id="addTasks" class="settings-btn">å¢åŠ ä»»åŠ¡</button>
      </div>
    </div>

    <div class="task-container" id="taskContainer"></div>
  </div>

  <script>
    let tasks = [];
    let systemTitle = "ä»»åŠ¡é¢†å–ç³»ç»Ÿ";

    // ç¼“å­˜å¸¸ç”¨ DOM å…ƒç´ 
    const dom = {
      taskContainer: document.getElementById('taskContainer'),
      taskCount: document.getElementById('taskCount'),
      progressCount: document.getElementById('progressCount'),
      settingsForm: document.getElementById('settingsForm'),
      toggleSettingsBtn: document.getElementById('toggleSettings'),
      saveTasksBtn: document.getElementById('saveTasksBtn'),
      applySettings: document.getElementById('applySettings'),
      addTasks: document.getElementById('addTasks'),
      systemTitle: document.getElementById('systemTitle')
    };


    let currentVersion = 1; // ä¹è§‚é”ç‰ˆæœ¬å·
    async function loadTasks() {
      try {
        const res = await fetch('load.php');
        const data = await res.json();
        tasks = data.tasks || [];
        systemTitle = data.systemTitle || "ä»»åŠ¡é¢†å–ç³»ç»Ÿ";
        currentVersion = data.version || 1;
      } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
        tasks = [];
        systemTitle = "ä»»åŠ¡é¢†å–ç³»ç»Ÿ";
        currentVersion = 1;
      } finally {
        dom.systemTitle.textContent = systemTitle;
        document.title = systemTitle;
        renderTasks();
      }
    }

    async function saveTasks() {
      try {
        systemTitle = dom.systemTitle.textContent.trim();
        document.title = systemTitle;
        const response = await fetch('save.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            version: currentVersion,
            tasks,
            systemTitle
          })
        });
        const result = await response.json();

        if (response.status === 409) {
          alert(result.message);
          // é‡æ–°åŠ è½½æ•°æ®
          await loadTasks();
          return false;
        }

        if (result.status === 'ok') {
          currentVersion = result.newVersion;
          return true;
        } else {
          // å¤„ç†å…¶ä»–é”™è¯¯æƒ…å†µï¼Œä¾‹å¦‚æœåŠ¡å™¨è¿”å›é”™è¯¯ä¿¡æ¯ä½†ä¸æ˜¯ç‰ˆæœ¬å†²çª
          alert(result.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
          return false;
        }
      } catch (error) {
        console.error('ä¿å­˜ä»»åŠ¡å¤±è´¥:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        return false;
      }
    }


    function checkPassword() {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.classList.add('modal');  // æ·»åŠ  modal ç±»

        const content = document.createElement('div');
        content.classList.add('modal-content');  // æ·»åŠ  modal-content ç±»

        const title = document.createElement('h3');
        title.textContent = 'é‡è¦æ•°æ®è¢«ä¿®æ”¹ï¼Œéœ€è¦å¯†ç éªŒè¯';
        title.classList.add('modal-title');  // æ·»åŠ  modal-title ç±»

        const input = document.createElement('input');
        input.type = 'password';
        input.classList.add('modal-input');  // æ·»åŠ  modal-input ç±»

        const confirmButton = document.createElement('button');
        confirmButton.textContent = 'ç¡®è®¤';
        confirmButton.classList.add('modal-button');

        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.classList.add('modal-button');

        // åˆ›å»ºä¸€ä¸ªæŒ‰é’®å®¹å™¨
        const buttonsContainer = document.createElement('div');
        buttonsContainer.classList.add('modal-buttons');
        buttonsContainer.append(confirmButton, cancelButton);

        // ç¡®è®¤æŒ‰é’®äº‹ä»¶
        confirmButton.onclick = () => {
          document.body.removeChild(modal);
          if (input.value !== '3') {
            alert('å¯†ç é”™è¯¯ï¼');
            resolve(false);
          } else {
            resolve(true);
          }
        };
        // å–æ¶ˆæŒ‰é’®äº‹ä»¶
        cancelButton.onclick = () => {
          document.body.removeChild(modal);
          resolve(false);
        };

        content.append(title, input, buttonsContainer);
        modal.appendChild(content);
        document.body.appendChild(modal);
        input.focus();
      });
    }



    function getTaskInputValues() {
      return {
        taskCount: parseInt(dom.taskCount.value, 10),
        progressCount: parseInt(dom.progressCount.value, 10)
      };
    }

    function createTasks(taskCount, progressCount, reset = false) {
      const newTasks = [];
      const lastIndex = reset ? 0 : (tasks.length ? parseInt(tasks[tasks.length - 1].name.match(/\d+/)?.[0] || 0) : 0);

      for (let i = 1; i <= taskCount; i++) {
        const progresses = Array.from({ length: progressCount }, (_, j) => ({
          name: `${j + 1}æ ¡`,
          completed: false,
          assignee: ""
        }));
        newTasks.push({ name: `${lastIndex + i}ï¼š`, progresses });
      }

      return newTasks;
    }

    function updateToggleLabel(label, progress) {
      if (!progress.assignee) {
        label.textContent = 'å¾…é¢†å–';
        label.style.color = '#3498db';
      } else if (progress.completed) {
        label.textContent = 'å·²å®Œæˆ';
        label.style.color = '#28a745';
      } else {
        label.textContent = 'è¿›è¡Œä¸­';
        label.style.color = '#ffc107';
      }
    }

    function renderTasks() {
      dom.taskContainer.innerHTML = '';

      tasks.forEach((task, taskIndex) => {
        const taskSection = document.createElement('div');
        taskSection.className = 'task-section';

        const taskTitleWrapper = document.createElement('div');
        taskTitleWrapper.className = 'task-title-wrapper';
        taskTitleWrapper.style.display = 'flex';
        taskTitleWrapper.style.justifyContent = 'space-between';
        taskTitleWrapper.style.alignItems = 'center';

        const taskTitle = document.createElement('div');
        taskTitle.className = 'task-title';
        taskTitle.contentEditable = true;
        taskTitle.textContent = task.name;
        taskTitle.style.flex = '1';
        taskTitle.addEventListener('blur', () => {
          tasks[taskIndex].name = taskTitle.textContent.trim();
        });

        // åˆ›å»ºæ’åºè¾“å…¥æ¡†
        const positionInput = document.createElement('input');
        positionInput.type = 'number';
        positionInput.min = '1';
        positionInput.max = tasks.length;
        positionInput.value = taskIndex + 1;
        positionInput.style = 'width: 20%; height: 30px; margin-left: 10px; text-align: center; max-width: 70px;';


        positionInput.addEventListener('change', () => {
          const newPosition = parseInt(positionInput.value) - 1;
          if (newPosition >= 0 && newPosition < tasks.length) {
            // ç§»åŠ¨ä»»åŠ¡åˆ°æ–°ä½ç½®
            const [movedTask] = tasks.splice(taskIndex, 1);
            tasks.splice(newPosition, 0, movedTask);
            renderTasks();
          } else {
            // æ¢å¤åŸæ¥çš„å€¼
            positionInput.value = taskIndex + 1;
          }
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.title = 'åˆ é™¤è¯¥ä»»åŠ¡';
        deleteBtn.style = 'cursor:pointer; border:none; background:transparent; font-size:16px;';
        deleteBtn.textContent = 'ğŸ—‘ï¸';
        deleteBtn.addEventListener('click', async () => {

          if (!await checkPassword()) return;
          tasks.splice(taskIndex, 1);
          renderTasks();
        });


        taskTitleWrapper.append(taskTitle, positionInput, deleteBtn);
        taskSection.appendChild(taskTitleWrapper);

        const progressList = document.createElement('div');
        progressList.className = 'progress-list';

        task.progresses.forEach((progress, progressIndex) => {
          if (progressIndex > 0) {
            const connector = document.createElement('div');
            connector.className = 'progress-connector';
            progressList.appendChild(connector);
          }

          const progressItem = document.createElement('div');
          progressItem.className = `progress-item ${progress.completed ? 'completed' : 'pending'}`;

          const progressInfo = document.createElement('div');
          progressInfo.className = 'progress-info';

          const statusIndicator = document.createElement('div');
          statusIndicator.className = `status-indicator ${progress.completed ? 'status-completed' : (progress.assignee ? 'status-pending' : 'status-pending-wait')}`;

          const progressName = document.createElement('div');
          progressName.className = 'progress-name';
          progressName.textContent = progress.name;

          const statusToggle = document.createElement('div');
          statusToggle.className = 'status-toggle';

          const toggleLabel = document.createElement('span');
          toggleLabel.className = 'toggle-label';
          updateToggleLabel(toggleLabel, progress);

          const toggleSwitch = document.createElement('label');
          toggleSwitch.className = 'toggle-switch';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = progress.completed;
          checkbox.onchange = () => {
            if (!progress.assignee) {
              alert("è¯·ç­‰å¾…ä¸Šä¸€çº§è¿›åº¦å®Œæˆåï¼Œå¹¶å¡«å†™å§“å");
              checkbox.checked = false;
              return;
            }
            if (checkbox.checked && progressIndex > 0 && !task.progresses[progressIndex - 1].completed) {
              alert("ä¸Šä¸€è¿›åº¦æœªå®Œæˆï¼");
              checkbox.checked = false;
              return;
            }
            progress.completed = checkbox.checked;
            renderTasks();
          };

          const slider = document.createElement('span');
          slider.className = 'slider';
          toggleSwitch.append(checkbox, slider);

          statusToggle.append(toggleLabel, toggleSwitch);
          progressInfo.append(statusIndicator, progressName, statusToggle);

          const assigneeEditor = document.createElement('div');
          assigneeEditor.className = 'assignee-editor';

          const canEdit = !progress.completed && (progressIndex === 0 || task progresses[progressIndex - 1].completed);
          assigneeEditor.contentEditable = canEdit;
          assigneeEditor.textContent = progress.assignee;
          assigneeEditor.style border = canEdit && !progress.assignee ? '1px solid #999' : 'none';

          assigneeEditor.addEventListener('blur', function () {
            const newName = this.textContent.trim();
            progress.å—è®©äºº = æ–°åç§°;
            æ›´æ–°åˆ‡æ¢æ ‡ç­¾ï¼ˆåˆ‡æ¢æ ‡ç­¾ï¼Œè¿›åº¦ï¼‰ï¼›
            renderTasks(); // ç›´æ¥åˆ·æ–°çŠ¶æ€
          });

          progressInfo.appendChild(assigneeEditor);
          progressItem.appendChild(progressInfo);
          progressList.appendChild(progressItem);
        });

        taskSection.appendChild(progressList);
        dom.taskContainer.appendChild(taskSection);
      });
    }

    // äº‹ä»¶ç»‘å®š
    dom.toggleSettingsBtn.addEventListener('click', () => {
      dom.settingsForm.classList.toggle('hidden');
      dom.toggleSettingsBtn.textContent = dom.settingsForm.classList.contains('hidden') ? 'åŠŸèƒ½èœå•' : 'æŠ˜å èœå•';
    });

    dom.applySettings.addEventListener('click', async () => {

      if (!await checkPassword()) return;
      const { taskCount, progressCount } = getTaskInputValues();
      tasks = createTasks(taskCount, progressCount, true);
      æ¸²æŸ“ä»»åŠ¡();
      dom.settingsForm.classList.add('hidden');
      dom.toggleSettingsBtn.textContent = 'åŠŸèƒ½èœå•';
    });


    dom.addTasks.addEventListener('click', async () => {

      if (!await checkPassword()) return;
      const { taskCount, progressCount } = getTaskInputValues();
      tasks.push(...createTasks(taskCount, progressCount));
      æ¸²æŸ“ä»»åŠ¡();
    });


    dom.saveTasksBtn.addEventListener('click', async () => {
      const isConfirmed = confirm("æ‚¨ç¡®å®šè¦ä¿å­˜æ‰€æœ‰ä¿®æ”¹å—ï¼Ÿ");
      if (isConfirmed) {
        const saved = await saveTasks();
        if (ä¿å­˜) {
          alert('ä¿å­˜æˆåŠŸï¼');
        }
      }
    });

    åŠ è½½ä»»åŠ¡();
  </script>


</html>
